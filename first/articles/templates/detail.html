{% extends 'base.html' %}

{% block title %} {{article.title}} {% endblock %}

{% block content%}

<h2>{{ article.title }}</h2>

<p>{{ article.text }}</p>

<em>{{ article.pub_date }}</em>

<hr>
<div class="comments" id="comments">
{% if all_comment %}
    {% for c in all_comment %}
        <div class = "comment_1" name= "comment" value = '{{ c.parent.id }}' >
            <p>

                <em>Комментатор: </em><strong>{{ c.parent.author_name }}</strong>
                <p> {{ c.parent.text }} </p>

                {% if c.child %}

                        {% for x in c.child %}
                            <div class="comment_2" name="comment_2" value="{{ c.parent.id }}+{{ x.parent.id }}"  hidden>
                                <p>
                                    <em>Комментатор: </em><strong>{{ x.parent.author_name }}</strong>
                                    <p> {{ x.parent.text }} </p>

        <!--                                <div answer анадлш-->
                                        {% if x.child %}

                                                {% for y in x.child %}
                                                    <div class="comment_3" name="comment_3" value="{{ c.parent.id }}+{{ x.parent.id }}+{{ y.id }}"  hidden >
                                                        <p>
                                                            <em>Комментатор: </em><strong>{{ y.author_name }}</strong>
                                                            <p> {{ y.text }} </p>
                                                            <div id="answer{{ y.parent.id }}"  hidden>

                                                                <form action='' method="POST">
                                                                    {% csrf_token %}

                                                                    <input type="text" id="add_name_comment_4_{{ c.parent.id }}+{{ x.parent.id }}+{{ y.id }}" required placeholder="Ваше имя" name="name"><br>
                                                                    <textarea  name="text" id='add_text_comment_4_{{ c.parent.id }}+{{ x.parent.id }}+{{ y.id }}' required="" placeholder="Текст комментрия" cols="30" rows="10"></textarea><br>
                                                                    <input type="button" id=4 class="sent_button_comment" value="Оставить комментраий" >  </input>
                                <!--                                    <input type="button" class="sent_button_comment" value="Ответить" id = '{{ x.parent.id }}'>  </input>-->

                                                                </form>


                                                            </div>

                                                            <button type="button" class = "answer_button" value="{{ y.parent.id }}" >Ответить</button>
                                                            {% if y.child %}
                                                                <button type="button" class = "answer_show_button" value="4" >Посмотреть ответы</button>
                                                                <button type="button" class = "answer_close_button" value="4" hidden>Закрыть</button>
                                                            {% endif %}
                                                            <button type="button" class = "cansel_button" value="{{ x.parent.id }}" hidden >Отмена</button>
                                                        <br>
                                                        </p>
                                                    </div>
                                                {% endfor %}
                                        {% endif %}
                                    <div id="answer{{ x.parent.id }}"  hidden>

                                        <form action='' method="POST">
                                            {% csrf_token %}

                                            <input type="text" id="add_name_comment_3_{{ c.parent.id }}+{{ x.parent.id }}" required placeholder="Ваше имя" name="name"><br>
                                            <textarea  name="text" id='add_text_comment_3_{{ c.parent.id }}+{{ x.parent.id }}' required="" placeholder="Текст комментрия" cols="30" rows="10"></textarea><br>
                                            <input type="button" id=3 class="sent_button_comment" value="Оставить комментраий" >  </input>
        <!--                                    <input type="button" class="sent_button_comment" value="Ответить" id = '{{ x.parent.id }}'>  </input>-->

                                        </form>


                                    </div>

                                    <button type="button" class = "answer_button" value="{{ x.parent.id }}" >Ответить</button>
                                    {% if x.child %}
                                        <button type="button" class = "answer_show_button" value="3" >Посмотреть ответы</button>
                                        <button type="button" class = "answer_close_button" value="3" hidden>Закрыть</button>
                                    {% endif %}
                                    <button type="button" class = "cansel_button" value="{{ x.parent.id }}" hidden >Отмена</button>
                                </p>
                            <br>
                            </div>
                        {% endfor %}
                {% endif %}
                <div id="answer{{ c.parent.id }}"  hidden>

                    <form action='' method="POST">
                        {% csrf_token %}

                        <input type="text" id="add_name_comment_2_{{ c.parent.id }}" required placeholder="Ваше имя" name="name"><br>
                        <textarea  name="text" id='add_text_comment_2_{{ c.parent.id }}' required="" placeholder="Текст комментрия" cols="30" rows="10"></textarea><br>
<!--                        <input type="button" class="sent_button_comment" value="Ответить" id = '{{ c.parent.id }}'>  </input>-->
                        <input type="button" id=2 class="sent_button_comment" value="Оставить комментраий" >  </input>

                    </form>


                </div>

                <button type="button" class = "answer_button" value="{{ c.parent.id }}" >Ответить</button>
                {% if c.child %}
                    <button type="button" class = "answer_show_button" value="2" >Посмотреть ответы</button>
                    <button type="button" class = "answer_close_button"  value="2" hidden>Закрыть</button>
                {% endif %}
                <button type="button" class="cansel_button" value="{{ c.parent.id }}" hidden >Отмена</button>

            </p>
        </div>
    {% endfor %}
{% else %}
    Комментарии не найдены, станьте первым!
{% endif %}
</div>
<hr>

<div id="add_comment">
    <form action='' method="POST">
        {% csrf_token %}

        <input type="text" id = 'add_name_comment_1' required placeholder="Ваше имя" name="name"><br>
        <textarea  name="text" id = 'add_text_comment_1' required="" placeholder="Текст комментрия" cols="30" rows="10"></textarea><br>
        <input type="button" id=1 class="sent_button_comment" value="Оставить комментраий"> </input>

    </form>
</div>


<style>
<!--    button-->
<!--    {-->
<!--        position: relative;-->
<!--        top: 5px;-->

<!--    }-->


<!--    .comment_comment-->
<!--    {-->
<!--        position: relative;-->

<!--        background: #ECF5E4; /* Цвет фона */-->
<!--    }-->

<!--    .comment_comment_comment-->
<!--    {-->
<!--        position: relative;-->
<!--        left: 40px;-->
<!--    }-->
</style>


    {% load static %}
    <script type="text/javascript" src="{% static 'articles/js/jquery-3.6.0.min.js' %}"></script>
<!--    <script type="text/javascript" src="{% static 'articles/js/detail.js' %}"></script>-->
<!--    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>-->



<script>


    document.addEventListener
    ( "click", function ( el )
        {

            if ( el.target && el.target.classList.contains( 'answer_show_button' ) )
            {
                el.target.hidden = true;


                var parent = el.target.parentNode;

                name_div ='div.comment_'.concat(el.target.value.toString())
                var child = parent.querySelectorAll(name_div);
                for (var ch = 0; ch < child.length; ch++ )
                {
                    child[ch].style.position = 'relative';
                    child[ch].style.left = '20px';
                    child[ch].hidden = false;

                }


<!--               Кнопка отмены просмотра комментария, класс назвывается answer_close_button последний -->

                var child = parent.querySelectorAll('button.answer_close_button');
                child[child.length - 1].hidden = false;

            }
            if ( el.target && el.target.classList.contains( 'answer_close_button' ) )
            {
<!--                el.target.hidden = true;-->

                var parent = el.target.parentNode;

                var child = parent.querySelectorAll('button.answer_show_button');
                var child_1 = parent.querySelectorAll('button.answer_close_button');

                for (var ch = 0; ch < child.length; ch++ )
                {
                    child[ch].hidden = false;
                    child_1[ch].hidden =true;
                }


                child = parent.getElementsByTagName('div');
                for (var ch in child)
                {
                    child[ch].hidden = true;
                }


                var cansel_button = parent.getElementsByClassName('cansel_button');

                for (var i = 0; i < cansel_button.length; i++)
                {
                    if (cansel_button[i].hidden == false)
                    {
                        (cansel_button[i].click());
                    }
                }

<!--                cansel_button-->
            }
            else if ( el.target && el.target.classList.contains( 'answer_button' ) )
            {

                tmp_text = 'answer'.concat(el.target.value.toString());

<!--                Форма ввода комментария, назвывается ансвер + id-->
                document.getElementById(tmp_text).hidden = false;

                var answer_button = document.getElementsByClassName('answer_button');
                var cansel_button = document.getElementsByClassName('cansel_button');



                for (var i = 0; i < answer_button.length; i++)
                {
                   answer_button[i].hidden = true;
                   if (el.target == answer_button[i])
                   {
                        cansel_button[i].hidden = false;
                   }
                }

                document.getElementById("add_comment").hidden = true;

            }
            else if (el.target && el.target.classList.contains( 'cansel_button' ))
            {

                tmp_text = 'answer'.concat(el.target.value.toString());
                document.getElementById(tmp_text).hidden = true;

                var answer_button = document.getElementsByClassName('answer_button');
                var cansel_button = document.getElementsByClassName('cansel_button');

                for (var i = 0; i < answer_button.length; i++)
                {
                   answer_button[i].hidden = false;
                   cansel_button[i].hidden = true;
                }
                document.getElementById("add_comment").hidden = false;
            }
        }
    )


     $(".sent_button_comment").click
    (
        function (obj)
        {

            console.log(obj.target.id)
            if (obj.target.id == 1)
            {
                username_comment = $("#add_name_comment_1").val();
                text_comment = $("#add_text_comment_1").val();
                article_id = {{ article.id }};

                sent_data =
                {
                    "username": username_comment,
                    "text": text_comment,
                    "article_id": article_id,
                    "parent_id": '',
                    "csrfmiddlewaretoken":"{{ csrf_token }}",
                };
                url = "{% url 'articles:ajax_post_data' %}";
                $.ajax
                (
                    {
                        url:url,
                        type:"post",
                        data:sent_data,
                        success:function (data)
                        {

                            var article_div = document.querySelector("div.comments");
                            if (article_div.children.length > 10)
                            {
                                article_div.removeChild( article_div.lastElementChild)
                            }


                                if (data['id'] != null)
                                {

    <!--                            <div class = "comment" name= "comment" value = 'c.parent.id'> То что создаю-->
                                    var comment = document.createElement("div");
                                    comment.setAttribute('class', 'comment');
                                    comment.setAttribute('name', 'comment');
                                    comment.setAttribute('value', data["id"]);

                                    var username = document.createElement("strong");
                                    var add_text_comment = document.createElement("p");
                                    var p = document.createElement("p");

                                    var em = document.createElement("em");
                                    em.textContent = 'Комментатор: ';
                                    p.appendChild(em);


                                    author_name = username_comment;
                                    comment_text = text_comment;

                                    username.textContent = author_name;
                                    add_text_comment.textContent = comment_text;


                                    p.appendChild(username);
                                    p.appendChild(add_text_comment);


    <!--                            <div id="answer{{ c.id }}"  hidden>-->
                                    var answer_div = document.createElement('div');
                                    tmp_text = 'answer'.concat(data['id'].toString());
                                    answer_div.setAttribute('id', tmp_text);
                                    answer_div.hidden = true;

<!--                                   <form action='' method="POST">-->
<!--                                        {% csrf_token %}-->

<!--                                        <input type="text" id="add_name_comment_2_{{ c.parent.id }}" required placeholder="Ваше имя" name="name"><br>-->
<!--                                        <textarea  name="text" id='add_text_comment_2_{{ c.parent.id }}' required="" placeholder="Текст комментрия" cols="30" rows="10"></textarea><br>-->
<!--                                        <input type="button" id=2 class="sent_button_comment" value="Оставить комментраий" >  </input>-->

<!--                                    </form>-->

                                    var form = document.createElement('form');
                                    form.setAttribute('method', "POST");
                                    form.action = true;

                                    var csrfmiddlewaretoken = document.createElement('input');
                                    csrfmiddlewaretoken.setAttribute('value', "{{ csrf_token }}");
                                    csrfmiddlewaretoken.setAttribute('name', "csrfmiddlewaretoken");
                                    csrfmiddlewaretoken.hidden = true;
                                    form.appendChild(csrfmiddlewaretoken)

                                    var br = document.createElement('br');
                                    form.appendChild(br)

                                    var add_name_comment_2 = document.createElement('input');
                                    add_name_comment_2.setAttribute('type', "text");
                                    add_name_comment_2.setAttribute('placeholder', "Ваше имя");
                                    add_name_comment_2.setAttribute('name', "name");
                                    add_name_comment_2.required = true;
                                    form.appendChild(add_name_comment_2)

                                    var br = document.createElement('br');
                                    form.appendChild(br)

                                    var add_text_comment_2 = document.createElement('textarea');
                                    add_text_comment_2.setAttribute('cols', 20);
                                    add_text_comment_2.setAttribute('rows', 8);
                                    add_text_comment_2.setAttribute('placeholder', "Текст комментрия");
                                    add_text_comment_2.setAttribute('name', "text");
                                    add_text_comment_2.required = true;
                                    form.appendChild(add_text_comment_2)

                                    var br = document.createElement('br');
                                    form.appendChild(br)

                                    var sent_button_comment_2 = document.createElement('input');
                                    sent_button_comment_2.setAttribute('class', "sent_button_comment");
                                    sent_button_comment_2.setAttribute('type', "button");
                                    sent_button_comment_2.setAttribute('id', 2);
                                    sent_button_comment_2.setAttribute('value', 'Ответить');

                                    form.appendChild(sent_button_comment_2)

                                    answer_div.appendChild(form)

    <!--                <button type="button" class = "cansel_button" value="{{ c.id }}" hidden >Отмена</button>-->
                                    var cansel_button = document.createElement('button');
                                    cansel_button.setAttribute('class', 'cansel_button');
                                    cansel_button.setAttribute('type', 'button');
                                    cansel_button.setAttribute('value', data['id']);
                                    cansel_button.textContent = 'Отмена';
                                    cansel_button.hidden = true;


<!--<                   button type="button" class = "answer_button" value="{{ c.parent.id }}" >Ответить</button>-->
                                    var answer_button = document.createElement('button');
                                    answer_button.setAttribute('class', 'answer_button');
                                    answer_button.setAttribute('type', 'button');
                                    answer_button.setAttribute('value', data['id']);
                                    answer_button.textContent = 'Ответить';

                                    p.appendChild(answer_div);
                                    p.appendChild(answer_button);
                                    p.appendChild(cansel_button);

                                    comment.appendChild(p);
                                    article_div.insertBefore( comment , article_div.firstElementChild)
                                }



                            document.getElementById("add_text_comment_1").value = "";
                            document.getElementById("add_name_comment_1").value = "";

                            var article_div = document.querySelector("div.comments");
                        },
                        error:function (error)
                        {
                            console.log(error);
                        }
                    }
                )
            }

            else
            {
                var parent = obj.target.parentNode.parentNode.parentNode;
                parent_id = (parent.getAttribute('value').toString());


                var name_input ='add_name_comment_'.concat(obj.target.id.toString()).concat('_').concat(parent.getAttribute('value').toString());
                var text_area ='add_text_comment_'.concat(obj.target.id.toString()).concat('_').concat(parent.getAttribute('value').toString());


                document.getElementById(tmp_text).hidden = false;
                username_comment =  document.getElementById(name_input).value;
                text_comment =  document.getElementById(text_area).value;
                article_id = {{ article.id }};



                sent_data =
                {
                    "username": username_comment,
                    "text": text_comment,
                    "article_id": article_id,
                    "parent_id": parent_id,
                    "csrfmiddlewaretoken":"{{ csrf_token }}",
                };
                url = "{% url 'articles:ajax_post_data' %}";
                $.ajax
                (
                    {

                        url:url,
                        type:"post",
                        data:sent_data,
                        success:function (data)
                        {

                            div_name = 'div.comment_'.concat(obj.target.getAttribute('id').toString());
                            var lvl_comment = (obj.target.getAttribute('id').toString())


                            if (data['id'] != null)
                            {


<!--                                    <div class = "comment_#" name= "comment_#" value = 'c.parent.id'> То что создаю&ndash;&gt;-->
                                    var comment = document.createElement("div");
                                    comment.setAttribute('class', 'comment_'.concat(lvl_comment));
                                    comment.setAttribute('name', 'comment_'.concat(lvl_comment));
                                    comment.setAttribute('value', data["parents_id"]);
                                    comment.style.position = 'relative';
                                    comment.style.left = '20px';
                                    comment.hidden = false;


                                    var username = document.createElement("strong");
                                    var add_text_comment = document.createElement("p");
                                    var p = document.createElement("p");

                                    var em = document.createElement("em");
                                    em.textContent = 'Комментатор: ';
                                    p.appendChild(em);


                                    author_name = username_comment;
                                    comment_text = text_comment;

                                    username.textContent = author_name;
                                    add_text_comment.textContent = comment_text;


                                    p.appendChild(username);
                                    p.appendChild(add_text_comment);


    <!--                            <div id="answer{{ c.parent.id  }}"  hidden>-->
                                    var answer_div = document.createElement('div');
                                    div_answer_name = 'answer'.concat(data['parents_id'].toString());
                                    answer_div.setAttribute('id', div_answer_name);
                                    answer_div.hidden = true;

<!--                                   <form action='' method="POST">-->
<!--                                        {% csrf_token %}-->

<!--                                        <input type="text" id="add_name_comment_2_{{ c.parent.id }}" required placeholder="Ваше имя" name="name"><br>-->
<!--                                        <textarea  name="text" id='add_text_comment_2_{{ c.parent.id }}' required="" placeholder="Текст комментрия" cols="30" rows="10"></textarea><br>-->
<!--                                        <input type="button" id=2 class="sent_button_comment" value="Оставить комментраий" >  </input>-->

<!--                                    </form>-->

                                    var form = document.createElement('form');
                                    form.setAttribute('method', "POST");
                                    form.action = true;

                                    var csrfmiddlewaretoken = document.createElement('input');
                                    csrfmiddlewaretoken.setAttribute('value', "{{ csrf_token }}");
                                    csrfmiddlewaretoken.setAttribute('name', "csrfmiddlewaretoken");
                                    csrfmiddlewaretoken.hidden = true;
                                    form.appendChild(csrfmiddlewaretoken)

                                    var br = document.createElement('br');
                                    form.appendChild(br)

                                    var add_name_comment = document.createElement('input');
                                    add_name_comment.setAttribute('type', "text");
                                    add_name_comment.setAttribute('placeholder', "Ваше имя");
                                    add_name_comment.setAttribute('id', 'add_name_comment_'.concat(lvl_comment).concat('_').concat(data['id'].toString()));
                                    add_name_comment.setAttribute('name', "name");
                                    add_name_comment.required = true;
                                    form.appendChild(add_name_comment)

                                    var br = document.createElement('br');
                                    form.appendChild(br)

                                    var add_text_comment = document.createElement('textarea');
                                    add_text_comment.setAttribute('cols', 20);
                                    add_text_comment.setAttribute('rows', 8);
                                    add_text_comment.setAttribute('placeholder', "Текст комментрия");
                                    add_text_comment.setAttribute('id', 'add_text_comment_'.concat(lvl_comment).concat('_').concat(data['id'].toString()));
                                    add_text_comment.setAttribute('name', "text");
                                    add_text_comment.required = true;
                                    form.appendChild(add_text_comment)

                                    var br = document.createElement('br');
                                    form.appendChild(br)

                                    var sent_button_comment = document.createElement('input');
                                    sent_button_comment.setAttribute('class', "sent_button_comment");
                                    sent_button_comment.setAttribute('type', "button");
                                    sent_button_comment.setAttribute('id', lvl_comment);
                                    sent_button_comment.setAttribute('value', 'Ответить');

                                    form.appendChild(sent_button_comment)

                                    answer_div.appendChild(form)

    <!--                <button type="button" class = "cansel_button" value="{{ c.parent.id }}" hidden >Отмена</button>-->
                                    var cansel_button = document.createElement('button');
                                    cansel_button.setAttribute('class', 'cansel_button');
                                    cansel_button.setAttribute('type', 'button');
                                    cansel_button.setAttribute('value', data['parents_id']);
                                    cansel_button.textContent = 'Отмена';
                                    cansel_button.hidden = true;


<!--<                   button type="button" class = "answer_button" value="{{ c.parent.id }}" >Ответить</button>-->
                                    var answer_button = document.createElement('button');
                                    answer_button.setAttribute('class', 'answer_button');
                                    answer_button.setAttribute('type', 'button');
                                    answer_button.setAttribute('value', data['parents_id']);
                                    answer_button.textContent = 'Ответить';

                                    p.appendChild(answer_div);
                                    p.appendChild(answer_button);
                                    p.appendChild(cansel_button);

                                    comment.appendChild(p);

    <!--                         Для проверки ответов комментарии, если есть, поверх-->

                                    var childs = parent.querySelectorAll(div_name)
                                    if (childs.length == 0)
                                    {
                                        childs = parent.querySelectorAll('div')
                                        parent.insertBefore( comment , childs[0])
                                    }
                                    else
                                    {
                                        parent.insertBefore( comment , childs[0])
                                    }


                                var form = obj.target.parentNode;
                                var ageElems = form.elements.name;
                                var tageElems = form.elements.text;
                                (ageElems.value = '');
                                (tageElems.value = '');

                                var cancel_button = document.getElementsByClassName('cansel_button');

                                for (var i = 0; i < cancel_button.length; i++)
                                {
                                    console.log(cancel_button[i]);
                                    if (cancel_button[i].hidden == false)
                                    {
                                        console.log(cancel_button[i]);
                                        (cancel_button[i].click());
                                    }
                                }
<!--                 Нажать на кнопку Cancel               console.log(parent.childNodes.length)-->
<!--                                console.log(parent.childNodes[parent.children.length - 40]);-->
<!--                                console.log(parent.childNodes);-->

                            }
                            else
                            {
                                console.log('Что пошло не так!');
                            }
                        }
                    }
                )

            }




        }
    )

</script>






{% endblock %}